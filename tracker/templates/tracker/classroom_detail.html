{% extends "tracker/dashboard_base.html" %}
{% load static %}

{% block admin_body %}
<div class="container-fluid px-2 py-0">
    <form class="row gy-3">

        <!-- Show Notes Option -->
        <div class="col-md-4">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="show_notes" {% if settings.show_notes %}checked{% endif %} name="show_notes">
                <label class="form-check-label" for="show_notes">
                    Show Notes
                </label>
            </div>
        </div>

        <!-- Notes Count -->
        <div class="col-md-4">
            <label for="notes_count" class="form-label">Number of Notes</label>
            <select class="form-select" id="notes_count" name="notes_count" style="width: 30%;">
                <option value="0" {% if settings.notes_count == 0 %}selected{% endif %}>0</option>
                <option value="1" {% if settings.notes_count == 1 %}selected{% endif %}>1</option>
                <option value="2" {% if settings.notes_count == 2 %}selected{% endif %}>2</option>
                <option value="3" {% if settings.notes_count == 3 %}selected{% endif %}>3</option>
                <option value="4" {% if settings.notes_count == 4 %}selected{% endif %}>4</option>
                <option value="5" {% if settings.notes_count == 5 %}selected{% endif %}>5</option>
            </select>
        </div>

        <!-- Show Stars Option -->
        <div class="col-md-4">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="show_stars" {% if settings.show_stars %}checked{% endif %} name="show_stars">
                <label class="form-check-label" for="show_stars">
                    Show Stars
                </label>
            </div>
        </div>

    </form>
</div>

<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-table me-1"></i>
        {{ classroom.name }}
    </div>
    <table id="treeview-table" class="table table-bordered">
        <thead>
            <tr>
                <th>Name</th>
                <th>Notes</th>
                <th>Stars</th>
                <th>Button</th>
            </tr>
        </thead>
        <tbody>
            <!-- rows go here -->
        </tbody>
    </table>
</div>

{% endblock %}

{% block admin_scripts %}
<script>
    
    document.addEventListener('DOMContentLoaded', function () {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';

        const settingsFields = ['show_notes', 'show_stars', 'notes_count'];

        settingsFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
                el.addEventListener('change', () => {
                    let value;

                    if (el.type === 'checkbox') {
                        value = el.checked;
                    } else {
                        value = el.value;
                    }

                    fetch('/api/treeview-settings/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({ [field]: value })
                    })
                        .then(res => res.json())
                        .then(data => console.log(`Updated ${field}:`, data))
                        .catch(err => console.error(`Error updating ${field}:`, err));
                });
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const classroomId = {{ classroom.id }};
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
        const tableBody = document.querySelector('#treeview-table tbody');

        if (!tableBody) return console.error("Table body not found");

        fetch('/api/students/')
            .then(res => res.json())
            .then(data => {
                const students = data
                    .filter(s => s.classroom_id === classroomId)
                    .sort((a, b) => (b.stars_count || 0) - (a.stars_count || 0));
                console.log("Filtered Students:", students);

                students.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.name}</td>
                        <td>${student.notes ?? '-'}</td>
                        <td class="stars-count">${'⭐'.repeat(student.stars_count || 0)}</td>
                        <td>
                            <button class="btn btn-primary add-star-btn" data-student-id="${student.id}">Add A Star</button>
                            <button class="btn btn-danger remove-star-btn" data-student-id="${student.id}">Remove A Star</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // Attach event listeners AFTER all rows are appended
                document.querySelectorAll('.add-star-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        const studentId = this.getAttribute('data-student-id');
                        const starsCell = this.closest('tr').querySelector('.stars-count');
                        const current = starsCell.textContent.length;

                        fetch('/api/treeview-settings/increment-star/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ student_id: studentId })  // Modify this if your API doesn't actually use student_id
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                const starsCell = this.closest('tr').querySelector('.stars-count');
                                let current = starsCell.textContent.length;
                                starsCell.textContent = '⭐'.repeat(current + 1);
                            }
                        })
                        .catch(err => console.error(err));
                    });
                });
                document.querySelectorAll('.remove-star-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        const studentId = this.getAttribute('data-student-id');
                        const starsCell = this.closest('tr').querySelector('.stars-count');
                        const current = starsCell.textContent.length;

                        fetch('/api/treeview-settings/remove-star/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ student_id: studentId })  // Modify this if your API doesn't actually use student_id
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                const starsCell = this.closest('tr').querySelector('.stars-count');
                                let current = starsCell.textContent.length;
                                starsCell.textContent = '⭐'.repeat(Math.max(current - 1, 0));
                            }
                        })
                        .catch(err => console.error(err));
                    });
                });
            })
            .catch(error => console.error('Error:', error));
    });
</script>

{% endblock %}